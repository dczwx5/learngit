---
title: 值类型和引用类型, 装箱和拆箱
grammar_cjkRuby: true
---
[TOC]
## new操作
* 计算所需内存空间
	* 计算目标类型, 包括System.Object类所需要的字节数
	* 类型对象指针,同步索引块(额外)
* 分配的空间, 所有字节都设为0
* 初始化类型对象指针, 同步块索引
* 调用构造器, 负责初始化该类型定义的实例字段
* 返回新建对象的引用(新建的变量是一个指向某类型对象的引用, 非对象本身)
## 值类型
* 两种表示方式, 未装箱与已装箱
* 一般分配在线程栈, 不受gc影响
* 派生于System.ValueType
* 值类型同样可以new创建(结构)
* 结构属于值类型
* 值类型不能派生出其他的类型
* 隐式密封
* 值类型的变量直接包含值
* 将值类型变量赋给另一个值类型变量时, 将复制其包含的值
* 存在堆中的值类型 **
	* 数组中的元素
	* 引用类型中的值类型字段
	* 控器块中的局部变量
	* 闭包情况下匿名函数的局部变量
	* 如果以上值类型分配在栈上, 可能会随着被调用方法的返回而被清除掉, 因此分配在堆上
* 值类型数据结构
	* 数字型 : int32, float, decimal
	* 布尔类型 : Boolean
	* 用户自定义的结构(注意占空间大的结构, 复制代价大)
	* DataTime
	* 枚举
	* Vector2, Vector3, Vector4
* 值类型在传递参数时, 性能没引用类型好
* 适合使用值类型的情况
	* 类型占用空间小
	* 类型占用空间大时, 不作为实参或返回值
## 引用类型
* UnityEngine.Object是Unity3D中c#脚本最基本的类(冒似越界了)
* 托管堆分配
* new 创建的对象(并非所有new创建的都属于引用(结构))
* 静态变量也存在堆上
* 参考new操作
* 由系统自动回收, gc
* 赋值只复制对象的引用
* 引用类型数据结构
	* class
	* interface
	* delegate
	* Dynamic
	* string **
	* Object
## 装箱
* 当会导致值类型要转换为引用类型时, 才会引起装箱
* 装箱机制是指将值类型转换为引用类型
```csharp
// 下例, 数组存在堆中, 而值类型存在栈中, 将值类型添加到数组中时, 需要将值类型转化成引用(装箱操作)
// 堆
ArrayList list = new ArrayList();
// 栈
int value = 100;
// 将值类型value装箱, 并将引用添加到list中
list.Add(value);
```
* 操作
	* 堆中分配内存(存放原本值类型转化后的引用)**
	* 将值类型的字段复制到堆中
	* 返回引用
## 拆箱与复制
* 拆箱与复制是指将引用类型转换为值类型
* 拆箱 只是获得需要拆箱的字段的地址, 而将复制值是拆箱之后的复制操作
```csharp
// 堆
ArrayList list = new ArrayList();
list.Add(100);
// 栈
int value;
// 拆箱, list[0]是引用类型, value是值类型, 需要将list[0]拆箱转换为值类型
value = list[0];
```
* 拆箱与复制
	* 拆箱 : 获得字段地址
	* 从拆箱获得的地址复制值到目标值类型上(非拆箱)
## 装箱拆箱总结
* 性能影响
* 内存影响, 增加碎片内存, 增加gc次数
* 应减少装箱, 拆箱, 复制操作
* List<T>不会产生装箱拆箱
* 导致装箱的原因是, 需要在值类型与引用类型间进行转换

```csharp
object o = 1 ;
// 以下是IL代码
.locals init (
　　[0] object objValue
　　) //以上三行IL表示声明object类型的名称为objValue的局部变量
 
　　IL_0000: nop
　　IL_0001: ldc.i4.s 1 //表示将整型数1放到栈顶
　　IL_0003: box [mscorlib]System.Int32 //执行IL box指令，在内存堆中申请System.Int32类型需要的堆空间
　　IL_0008: stloc.0 //弹出堆栈上的变量，将它存储到索引为0的局部变量中
```
```csharp
int value = (int)objValue;　　
// 以下IL代码
　　IL_0008: ldloc.0//将索引为0的局部变量(即objValue变量)压入栈
　　IL_0009: unbox.any [mscorlib]System.Int32 //执行IL 拆箱指令unbox.any 将引用类型object转换成System.Int32类型
　　IL_000e: stloc.1 //将栈上的数据存储到索引为1的局部变量即value
```
# END
